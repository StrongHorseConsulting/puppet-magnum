require 'rake'
require 'rspec/core/rake_task'
require 'puppet-lint/tasks/puppet-lint'
require 'puppetlabs_spec_helper/rake_tasks'

desc 'Run syntax, lint and acceptance tests'
task :test do
  Rake::Task[:spec_clean].invoke
  Rake::Task[:spec_prep].invoke

  Rake::Task[:syntax].invoke
  Rake::Task[:lint].invoke

  Rake::Task[:docker].invoke
end

# puppet-lint options
Rake::Task[:lint].clear
PuppetLint::RakeTask.new :lint do |config|
  config.ignore_paths = ['spec/**/*.pp']
  config.log_format = '%{path}:%{line}:%{check}:%{KIND}:%{message}'
  config.disable_checks = [ 'class_inherits_from_params_class', '80chars' ]
  config.fail_on_warnings = false
end

desc 'Run tests using Virtualbox: <up|provision|ssh|destroy> [spec test] [sut]'
task :vbox do

  ARGV.each { |a| task a.to_sym do ; end }

  # Default Beaker ENV settings
  ENV['PUPPET_INSTALL_TYPE'] = 'agent'

  # Default to the spec test generated by puppet-magnum
  spec_test = 'spec/acceptance/<%= module_name %>_spec.rb'
  unless ARGV[2].nil?
    spec_test = ARGV[2]
  end

  # Default to testing on Ubuntu 16.04
  sut = 'ubuntu-server-1604-x64'
  unless ARGV[3].nil?
    sut = ARGV[3]
  end
  ENV['BEAKER_set']= sut

  case ARGV[1]
  when "up"
    ENV['BEAKER_provision'] = 'yes'
    ENV['BEAKER_destroy'] = 'no'
    cmd = "bundle exec rspec #{spec_test}"
    system(cmd)
  when "provision"
    ENV['BEAKER_provision'] = 'no'
    ENV['BEAKER_destroy'] = 'no'
    cmd = "bundle exec rspec #{spec_test}"
    system(cmd)
  when "destroy"
    ENV['BEAKER_provision'] = 'no'
    ENV['BEAKER_destroy'] = 'no'
    cmd = "cd .vagrant/beaker_vagrant_files/#{sut}.yml ; vagrant destroy --force"
    system(cmd)
  when "ssh"
    cmd = "bundle exec rake beaker:ssh:#{sut}"
    system(cmd)
  end

end

desc 'Run tests using Docker: <up|provision|ssh|destroy|ci> [spec test] [sut]'
task :docker do

  ARGV.each { |a| task a.to_sym do ; end }

  # Default Beaker ENV settings
  ENV['PUPPET_INSTALL_TYPE'] = 'agent'

  # Set the nodset dir to use Docker
  ENV['BEAKER_setdir'] = 'spec/acceptance/nodesets/docker'

  # Default to the spec test generated by puppet-magnum
  spec_test = 'spec/acceptance/<%= module_name %>_spec.rb'
  unless ARGV[2].nil?
    spec_test = ARGV[2]
  end

  # Default to testing on Ubuntu 16.04
  sut = 'ubuntu-server-1604-x64'
  unless ARGV[3].nil?
    sut = ARGV[3]
  end
  ENV['BEAKER_set']= sut

  case ARGV[1]
  when "up"
    ENV['BEAKER_provision'] = 'yes'
    ENV['BEAKER_destroy'] = 'no'
    cmd = "bundle exec rspec #{spec_test}"
    system(cmd)
  when "provision"
    ENV['BEAKER_provision'] = 'no'
    ENV['BEAKER_destroy'] = 'no'
    cmd = "bundle exec rspec #{spec_test}"
    system(cmd)
  when "destroy"
    ENV['BEAKER_provision'] = 'no'
    ENV['BEAKER_destroy'] = 'no'
    cmd = "docker rm -fv beaker-test"
    system(cmd)
  when "ssh"
    cmd = "docker exec -it beaker-test bash"
    system(cmd)
  else
    ENV['BEAKER_provision'] = 'yes'
    ENV['BEAKER_destroy'] = 'yes'
    cmd = "bundle exec rspec #{spec_test}"
    system(cmd)
  end

end

# remove undesired rake tasks
task :build => []; Rake::Task[:build].clear
task :clean => []; Rake::Task[:clean].clear
task :default => []; Rake::Task[:default].clear
task :default => :test
